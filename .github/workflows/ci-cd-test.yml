name: CI/CD Pipeline for ML Project

on:
  push:
    branches:
      - develop
      - 'feature/*'
  pull_request:
    branches:
      - develop

# ë™ì¼í•œ ë¸Œëœì¹˜ì—ì„œ ìƒˆ ì›Œí¬í”Œë¡œìš°ê°€ ì‹œì‘ë˜ë©´ ì´ì „ ì›Œí¬í”Œë¡œìš° ì·¨ì†Œ
concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run CI tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # pip ì˜ì¡´ì„± ìºì‹±ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ml/requirements.txt
          pip install pytest flake8 black isort

      - name: Lint with flake8
        run: |
          # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ê²½ê³ ëŠ” í—ˆìš©, ì—ëŸ¬ë§Œ ì‹¤íŒ¨)
          flake8 ml/ml --count --select=E9,F63,F7,F82 --show-source --statistics
          # ì „ì²´ ë¦°íŒ… (ê²½ê³  í¬í•¨)
          flake8 ml/ml --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: Check import sorting with isort
        run: isort --check-only --diff ml/ml

      - name: Check code formatting with black
        run: black --check --diff ml/ml

      - name: Run tests with pytest
        run: |
          # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ì²´í¬
          pytest ml/ml --verbose --tb=short

      - name: Test Docker build
        run: |
          # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ì´ë¯¸ì§€ ë¬´ê²°ì„± í™•ì¸)
          cd ml/ml
          docker build -t ml-app-test .
          docker rmi ml-app-test

  deploy:
    name: Deploy to EC2
    needs: test    # CI í†µê³¼í•´ì•¼ ë°°í¬ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest
    # develop ë¸Œëœì¹˜ì—ì„œë§Œ ë°°í¬ ì‹¤í–‰
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ML_EC2_SSH_KEY }}

      - name: Deploy to EC2 and restart container
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            set -e  # ì—ëŸ¬ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
            set -x  # ì‹¤í–‰ ëª…ë ¹ì–´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            
            echo "=== ë°°í¬ ì‹œì‘: $(date) ==="
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/ml/ml || {
              echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            }
            
            echo "=== Git ì—…ë°ì´íŠ¸ ==="
            # ë¸Œëœì¹˜ ë™ì  ì²˜ë¦¬ (í•˜ë“œì½”ë”© ì œê±°)
            BRANCH_NAME="${{ github.ref_name }}"
            echo "ë°°í¬í•  ë¸Œëœì¹˜: $BRANCH_NAME"
            
            # Git ìƒíƒœ í™•ì¸ ë° ì—…ë°ì´íŠ¸
            git fetch origin "$BRANCH_NAME" || {
              echo "âŒ Git fetch ì‹¤íŒ¨"
              exit 1
            }
            
            git reset --hard "origin/$BRANCH_NAME" || {
              echo "âŒ Git reset ì‹¤íŒ¨"
              exit 1
            }
            
            echo "í˜„ì¬ ì»¤ë°‹: $(git rev-parse HEAD)"
            
            echo "=== Docker ì»¨í…Œì´ë„ˆ ê´€ë¦¬ ==="
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if docker compose ps | grep -q "ml"; then
              echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
              docker compose down || echo "âš ï¸ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘ ì¼ë¶€ ì˜¤ë¥˜ ë°œìƒ (ë¬´ì‹œë¨)"
            fi
            
            # ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬
            docker system prune -f || echo "âš ï¸ Docker ì •ë¦¬ ì¤‘ ì¼ë¶€ ì˜¤ë¥˜ ë°œìƒ (ë¬´ì‹œë¨)"
            
            echo "=== ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ==="
            # ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
            docker compose up -d --build || {
              echo "âŒ Docker ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨"
              echo "=== Docker ë¡œê·¸ í™•ì¸ ==="
              docker compose logs --tail=50
              exit 1
            }
            
            echo "=== ë°°í¬ ìƒíƒœ í™•ì¸ ==="
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            docker compose ps
            
            # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 3ë¶„ ëŒ€ê¸°)
            echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            for i in {1..6}; do
              echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/6..."
              if docker compose exec -T ml-app curl -f http://localhost:8000/health 2>/dev/null; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
                break
              elif [ $i -eq 6 ]; then
                echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨"
                echo "=== ìµœê·¼ ë¡œê·¸ í™•ì¸ ==="
                docker compose logs --tail=100
                exit 1
              else
                echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/6)"
                sleep 30
              fi
            done
            
            echo "=== ìµœê·¼ ë¡œê·¸ í™•ì¸ ==="
            docker compose logs --tail=20
            
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ: $(date)"
          EOF

      - name: Deployment Success Notification
        if: success()
        run: |
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"

      - name: Deployment Failure Notification  
        if: failure()
        run: |
          echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
