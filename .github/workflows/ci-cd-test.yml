name: CI/CD Pipeline for ML Project

on:
  push:
    branches:
      - develop
      - 'feature/*'
  pull_request:
    branches:
      - develop

# ë™ì¼í•œ ë¸Œëœì¹˜ì—ì„œ ìƒˆ ì›Œí¬í”Œë¡œìš°ê°€ ì‹œì‘ë˜ë©´ ì´ì „ ì›Œí¬í”Œë¡œìš° ì·¨ì†Œ
concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run CI tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # pip ì˜ì¡´ì„± ìºì‹±ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ml/requirements.txt
          pip install pytest flake8 black isort

      - name: Lint (flake8)          # continue-on-error â†’ ê²½ê³ ë¡œë§Œ
        run: flake8 ml --select=E9,F63,F7,F82 --statistics
        continue-on-error: true

      - name: Lint (isort check)
        run: isort --check-only --diff ml
        continue-on-error: true

      - name: Lint (black check)
        run: black --check --diff ml
        continue-on-error: true

      - name: Run tests
        run: pytest ml --verbose --tb=short

      - name: Test Docker build
        run: |
          # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ì´ë¯¸ì§€ ë¬´ê²°ì„± í™•ì¸)
          cd ml
          docker build -t ml-app-test .
          docker rmi ml-app-test
          
  deploy:
    name: Deploy to EC2
    needs: test
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/')) && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ML_EC2_SSH_KEY }}

      - name: Deploy & restart container on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
              ubuntu@${{ secrets.EC2_HOST }} << 'SSH_EOF'
            set -e

            echo "=== ë°°í¬ ì‹œì‘: $(date) ==="
            cd ~/ml/ml

            # Git ì—…ë°ì´íŠ¸
            BRANCH="${{ github.ref_name }}"
            git fetch origin "$BRANCH"
            git reset --hard "origin/$BRANCH"

            # .env ì‘ì„±
            cat > .env << 'ENV_EOF'
OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
HOST=0.0.0.0
PORT=8000
RELOAD=true
CLAUDE_MODEL=claude-sonnet-4-20250514
ENV_EOF

            # ì»¨í…Œì´ë„ˆ ì¬ë°°í¬
            docker compose down || true
            docker compose up -d --build

            docker compose ps
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ: $(date)"
SSH_EOF
